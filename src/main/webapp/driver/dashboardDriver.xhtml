<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="jakarta.faces.html"
                xmlns:ui="jakarta.faces.facelets"
                xmlns:f="jakarta.faces.core"
                template="/partial/drivertemplate.xhtml"
                xmlns:p="http://primefaces.org/ui">

    <ui:define name="content">
        <style>
            #driverMap {
                width: 100%;
                z-index: 1;
            }
            .status-badge {
                padding: 0.25rem 0.5rem;
                border-radius: var(--radius-sm);
                font-weight: 600;
                font-size: 0.875rem;
            }
            .status-active {
                background-color: var(--color-accent-light);
                color: var(--color-dark);
            }
            .status-inactive {
                background-color: var(--color-gray-300);
                color: var(--color-gray-600);
            }
            .status-warning {
                background-color: #FEF3C7;
                color: #92400E;
            }
        </style>
        <h:outputScript>
            window.driverUsername = "#{dashboard.userName}";
            window.markerImageUrl = "#{resource['images/redbus.png']}";
        </h:outputScript>

        <div class="flex flex-row p-2">
            <div class="page-head-line">Driver Dashboard</div>
            <link href="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.css" rel="stylesheet" />
            <p:growl showSummary="true" life="3000" severity="info, error, fatal"><p:autoUpdate/></p:growl>
        </div>

        <!-- Driver Status Section -->
        <div class="flex flex-column flex-auto">
            <div class="p-2 min-h-full">
                <div class="grid h-full">
                    <div class="col-12">
                        <h:form id="statusForm">
                            <div class="surface-card shadow-2 p-4 border-round">
                                <div class="flex justify-content-between align-items-center">
                                    <div>
                                        <h3 class="m-0 fs-lg">Current Status</h3>
                                        <div class="mt-2">
                                            <span class="status-badge #{driverDashboard.status == 'ACTIVE' ? 'status-active' : driverDashboard.status == 'BREAK' ? 'status-warning' : 'status-inactive'}">
                                                #{driverDashboard.status}
                                            </span>
                                        </div>
                                    </div>

                                    <div>
                                        <p:selectOneButton value="#{driverDashboard.driverStatus}" unselectable="false">
                                            <f:selectItem itemLabel="Active" itemValue="ACTIVE" />
                                            <f:selectItem itemLabel="On Break" itemValue="BREAK" />
                                            <f:selectItem itemLabel="Off Duty" itemValue="OFFLINE" />
                                            <p:ajax update="@form" listener="#{driverDashboard.updateStatus}" />
                                        </p:selectOneButton>
                                    </div>
                                </div>
                            </div>
                        </h:form>
                    </div>

                    <!-- Driver KPIs -->

                    <!-- Vehicle KPIs -->
                    <div class="col-12">
                        <ui:include src="/driver/vehicleKPIs.xhtml" />
                    </div>

                    <!-- Map and Route Section -->
                    <div class="col-12 lg:col-8">
                        <h:form id="mapForm">
                            <div class="surface-card shadow-2 border-round p-3">
                                <h3 class="m-0 mb-2 fs-lg flex align-items-center gap-2">
                                    <i class="fa fa-cloud"></i> Map
                                </h3>
                                <div class="grid">

                                    <div class="col-12">
                                        <div id="driverMap" class="map-container" style="width:100%; height:60vh;"></div>
                                    </div>
                                </div>
                            </div>
                        </h:form>
                    </div>

                    <!-- Weather and Vehicle Health -->
                    <div class="col-12 lg:col-4">
                        <div class="grid">
                            <div class="surface-card shadow-2 border-round p-4">
                            Weather Forecast
                            <p:lineChart model="#{weatherForecast.weatherChart}" style="width:100%; height:55vh;" />

                        </div>
                        </div>
                    </div>

                    <p:dialog id="driverInfoDialog" widgetVar="driverInfoDialog" 
                              header="Driver Information" modal="true" resizable="false" width="400">
                        <h:panelGrid columns="2" cellpadding="5">
                            <h:outputText value="Username:" />
                            <h:outputText id="modal-username" value="" />

                            <h:outputText value="First Name:" />
                            <h:outputText id="modal-firstName" value="" />

                            <h:outputText value="Last Name:" />
                            <h:outputText id="modal-lastName" value="" />

                            <h:outputText value="Vehicle Plate:" />
                            <h:outputText id="modal-vehiclePlate" value="" />

                            <h:outputText value="Vehicle Model:" />
                            <h:outputText id="modal-vehicleModel" value="" />
                        </h:panelGrid>

                        <f:facet name="footer">
                            <p:commandButton value="Close" onclick="PF('driverInfoDialog').hide()" />
                        </f:facet>
                    </p:dialog>
                </div>
            </div>
        </div>

        <!-- Map Scripts -->
        <script src="https://api.mapbox.com/mapbox-gl-js/v3.10.0/mapbox-gl.js"></script>
        <h:outputScript library="leaflet" name="leaflet.js"/>
        <h:outputScript library="js" name="driverMap.js"/>
        <h:outputScript library="js" name="turf.min.js"/>
    </ui:define>
</ui:composition>